name: YLP Weekly
on:
  schedule:
    - cron: '0 4 * * 0'
  workflow_dispatch:

jobs:

  check_changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
      - id: changes
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === "workflow_dispatch") {
              core.setOutput("has_changes", "true");
              return;
            }

            const { owner, repo } = context.repo;
            const tags = await github.rest.repos.listTags({ owner, repo });
            if (tags.data.length === 0) {
              core.setOutput("has_changes", "true");
              return;
            }

            const lastTag = tags.data[0].name;
            const compare = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: lastTag,
              head: "HEAD"
            });

            core.setOutput(
              "has_changes",
              compare.data.total_commits > 0 ? "true" : "false"
            );

  build:
    needs: check_changes
    if: needs.check_changes.outputs.has_changes == 'true'
    runs-on: windows-latest
    name: Build YLP CPP
    env:
      BUILD_TYPE: Release
    outputs:
      full_sha: ${{ steps.var.outputs.full_sha }}
      new_tag: ${{ steps.get_version.outputs.new_tag }}
      ffi_tag: ${{ steps.get_version.outputs.ffi_tag }}
      old_tag: ${{ steps.get_version.outputs.old_tag }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Get Version Number
        id: get_version
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tags = await github.rest.repos.listTags({ owner, repo });
            
            let newTag;
            let oldTag;
            let ffiTag;
            let latestTag = tags.data.length ? tags.data[0].name : "2.0.0.0";
            
            const versionParts = latestTag.split('.').map(Number);
            if (versionParts[0] < 2) {
                versionParts[0] = 2;
                versionParts[1] = 0;
                versionParts[2] = 0;
                versionParts[3] = 0;
            } else if (versionParts[1] === 9 && versionParts[2] === 9 && versionParts[3] === 9) {
                versionParts[0] += 1;
                versionParts[1] = 0;
                versionParts[2] = 0;
                versionParts[3] = 0;
            } else if (versionParts[2] === 9) {
                versionParts[1] += 1;
                versionParts[2] = 0;
                versionParts[3] = 0;
            } else if (versionParts[3] === 9) {
                versionParts[2] += 1;
                versionParts[3] = 0;
            } else {
                versionParts[3] += 1;
            }

            newTag = versionParts.join('.');
            oldTag = latestTag;
            ffiTag = newTag.replaceAll(".", ",");
            
            core.setOutput("new_tag", newTag);
            core.setOutput("ffi_tag", ffiTag);
            core.setOutput("old_tag", oldTag);

      - name: Update Version Resource
        shell: pwsh
        run: |
          $versionNumber = "${{ steps.get_version.outputs.ffi_tag }}"
          $versionString = "${{ steps.get_version.outputs.new_tag }}"
          $commit  = git rev-parse --short HEAD
          $file = "./src/resources/version.rc"
          $content = @"
          #include <windows.h>
          VS_VERSION_INFO VERSIONINFO
            FILEVERSION $versionNumber
            PRODUCTVERSION $versionNumber
            FILEFLAGSMASK 0x3fL
            FILEFLAGS 0x0L
            FILEOS VOS_NT_WINDOWS32
            FILETYPE VFT_APP
            FILESUBTYPE 0x0L
          BEGIN
              BLOCK "StringFileInfo"
              BEGIN
                  BLOCK "040904b0"
                  BEGIN
                      VALUE "CompanyName", "github.com/xesdoog\0"
                      VALUE "FileDescription", "YLP\0"
                      VALUE "FileVersion", "$versionString"
                      VALUE "InternalName", "YLP\0"
                      VALUE "LegalCopyright", "Copyright (c) SAMURAI - 2025\0"
                      VALUE "OriginalFilename", "YLP.exe\0"
                      VALUE "ProductName", "YLP\0"
                      VALUE "ProductVersion", "$versionString"
                  END
              END

              BLOCK "VarFileInfo"
              BEGIN
                  VALUE "Translation", 0x0409, 1200
              END
          END
          "@

          Set-Content -Path $file -Value $content -Encoding UTF8

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Generate CMake Files
        run: cmake -D CMAKE_BUILD_TYPE=Release -D OPTIMIZE=YES -S. -Bbuild -G Ninja

      - name: Build x64 Executable
        run: cmake --build ./build --config Release --target YLP

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary
          path: build/YLP.exe
          if-no-files-found: warn

      - name: Generate Build Info
        id: var
        run: |
          echo "full_sha=$(git rev-parse HEAD)" >> $env:GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $env:GITHUB_OUTPUT

  create_release:
    runs-on: ubuntu-latest
    name: Create Release
    needs: build
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate Changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const lastTag = "${{ needs.build.outputs.old_tag }}";
            const { data: tagRefs } = await github.rest.git.getRef({ owner, repo, ref: `tags/${lastTag}` });
            const tagSha = tagRefs.object.sha;
            const { data: tagCommit } = await github.rest.repos.getCommit({ owner, repo, ref: tagSha });
            const lastTagDate = new Date(tagCommit.commit.committer.date);
            const { data: pulls } = await github.rest.pulls.list({
              owner, repo, state: "closed", sort: "updated", direction: "asc", per_page: 100
            });

            let changelog = "";

            const mergedPRs = pulls.filter(pr => pr.merged_at && new Date(pr.merged_at) > lastTagDate);
            const extractField = (body, fieldName) => {
              const regex = new RegExp(`${fieldName}:\\s*([\\s\\S]*?)(?=\\n\\w+:|$)`, 'm');
              const match = body.match(regex);
              if (!match)
                return "";

              return match[1].trim();
            };

            if (mergedPRs.length > 0) {
              for (const pr of mergedPRs) {
                changelog += `## PR #${pr.number}: ${pr.title}\n`;
                const body = pr.body || "";

                const sections = {
                  "### ðŸš€ Features": extractField(body, "feature_text"),
                  "### ðŸ”§ Fixes": extractField(body, "fix_text"),
                  "### ðŸ§© Refactors": extractField(body, "refactor_text"),
                  "### ðŸ“ Documentation": extractField(body, "docs_text"),
                  "### ðŸ§¹ Chores": extractField(body, "chore_text")
                };

                for (const [heading, content] of Object.entries(sections)) {
                  if (content) {
                    const lines = content.split('\n').map(line => line.trim().replace(/^-\s*/, ''));
                    changelog += heading + "\n\n";
                    for (const line of lines) {
                      if (line)
                        changelog += `- ${line}\n`;
                    }
                    changelog += "\n";
                  }
                }
              }
            } else {
              const compared = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: lastTag,
                head: "main"
              });

              const commits = compared.data.commits;
              for (const commit of commits) {
                const msg = commit.commit.message;
                const body = commit.commit.body;
                if (msg.toLowerCase().startsWith("merge pull"))
                  continue;

                changelog += `## ${msg}\n\n`;
                if (body)
                  changelog += `${body}\n\n`;
              }
            }

            core.setOutput("changelog", changelog);

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: binary

      - name: Calculate SHA256
        id: build_sha
        run: |
          sha256sum YLP.exe > sha256.checksum
          echo "build_sha=$(cat sha256.checksum)" >> $GITHUB_OUTPUT
          cat sha256.checksum

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          name: YLP v${{ needs.build.outputs.new_tag }}
          tag_name: ${{ needs.build.outputs.new_tag }}
          body: |
              >[!NOTE]
              >**This automatic release was built by Github Actions**
              >| [Link to build](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
              >| ------------- |

              ### Build SHA256:
                    ${{ steps.build_sha.outputs.build_sha }}
              
              # Changelog
              ${{ steps.changelog.outputs.changelog }}
          files: |
            YLP.exe
